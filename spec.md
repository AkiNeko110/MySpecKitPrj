# 機能仕様書: ブラウザ版シンプル・インベーダーゲーム

## 概要 / コンテキスト
Web ブラウザ上でプレイできる、クラシックな固定画面式のインベーダーゲームを実装する。プレイヤーは画面下部のビーム砲を左右に操作し、上部から横隊で迫ってくるインベーダー編隊を撃墜して全滅させることを目標とする。インベーダーが画面最下部（プレイヤー位置）まで到達した場合は、残機があってもゲームオーバーとなる。

## 用語
- ビーム砲: プレイヤーが操作する自機。左右移動のみ可能。弾は同時に1発まで。
- トーチカ: ビーム砲上部に配置される防御壁。被弾や接触で破損する。
- インベーダー: 縦5段×横11列の55体の敵。隊列で横移動し、端到達で1段下降し進行方向を反転。
- 残機: プレイヤーが所持するビーム砲の数。被弾で1門失う。

## 画面 / レイアウト要件
- 固定画面。スクロールなし。
- 画面からインベーダーやビーム砲がはみ出さないように境界衝突を実装。
- インベーダー隊列は画面中央やや上に5段×11列で初期配置。
- ビーム砲は画面下段に初期配置。
- トーチカはビーム砲上部の所定位置に複数基配置（個数と座標は後述のデータモデルに準拠）。

## ゲーム進行 / ロジック
1. インベーダー移動
   - 全体として隊列で横移動。
   - 横端に到達したフレームで隊列全体が1段（一定ピクセル）下降し、横移動方向を反転。
   - 撃墜数が増えるほど、隊列の横移動速度（および端到達間隔）が徐々に上昇する。
2. 勝敗条件
   - 勝利: 55体を全滅させるとクリア。
   - 敗北: 隊列のいずれかがビーム砲の縦位置（最下段ライン）に達した時点でGAME OVER（残機有無に関わらず）。
3. プレイヤー操作
   - 入力: 左右移動、発射（単発制限）。
   - 弾は同時1発のみ。既発弾が着弾（敵命中、トーチカ命中、画面上端到達）するまで次弾は発射不可。
4. トーチカの破損
   - 敵弾命中で該当部位が部分的に破損。
   - 自弾が下方から貫通した場合も破損。
   - 降下してきたインベーダーが接触しても削られる。
5. プレイヤー被弾
   - 敵弾がビーム砲に命中するとミスとして残機を1失う。
   - 残機が0の状態で被弾、またはインベーダーが最下段到達で即 GAME OVER 表示。

## スコアリング
- 上段（最上段5×11のうち最上段1段）: 撃墜1体あたり30点
- 中段（上から2〜3段目の2段）: 撃墜1体あたり20点
- 下段（上から4〜5段目の2段）: 撃墜1体あたり10点
- スコアはリアルタイムで画面上部に表示し、ゲーム終了時に最終スコアを表示。

## 難易度調整（スピードスケーリング）
- 生存インベーダー数 N に応じて横移動の更新間隔を短縮する。
- 例: 基準間隔 `t0` に対し `t = max(t_min, t0 - k * (55 - N))` として逓減。
- `t_min` と係数 `k` はバランス調整用定数として設定可能。

## 入出力 / 操作
- キー操作（PC想定）addad
  - 左移動: 左矢印 / A
  - 右移動: 右矢印 / D
  - 発射: スペース
- モバイル（任意対応）
  - 画面下部に左右ボタンと発射ボタンを配置（対応する場合）。

## 当たり判定
- 種別: 自弾×インベーダー、自弾×トーチカ、敵弾×トーチカ、敵弾×ビーム砲、インベーダー×トーチカ、インベーダー×画面端/床。
- 方式: AABB（Axis-Aligned Bounding Box）による矩形判定を基本とし、トーチカはピクセルマスクまたは細分割タイルで段階的破損を表現。

## 表示 / エフェクト
- 撃墜時に短い点滅または爆発スプライト/エフェクトを表示。
- GAME OVER / CLEAR のオーバーレイ表示。
- 画面からのはみ出し防止のため、座標は境界でクランプ。

## 非機能要件
- ブラウザ互換: 最新版の Chromium/Firefox/Safari で動作。
- パフォーマンス: 60 FPS を目標（低負荷環境では最低 30 FPS を維持）。
- 入力遅延: 100ms 未満を目標。
- アセットサイズ: 初期ロード 2MB 未満を目安。

## データモデル（論理）
- GameState: `score`, `lives`, `wave`（初期1）, `state`（Playing/Cleared/GameOver）。
- Player: `x`, `y`, `speed`, `canFire`（bool）, `bullet`（存在時のみ）。
- Bullet: `x`, `y`, `vy`, `owner`（Player/Enemy）。同時発射制限は Player 側で制御。
- Invader: `row`, `col`, `x`, `y`, `alive`（bool）, `scoreValue`。
- Formation: `direction`（Left/Right）, `speed`, `stepDownPx`, `bounds`（minX/maxX）。
- Bunker(トーチカ): `shapeMask` または `tiles[][]` による破損表現。

## 状態遷移
- タイトル/準備 → プレイ中 → クリア or ゲームオーバー → リスタート可

## エッジケース
- プレイヤー弾と敵弾が同フレームで交差する場合の優先度（両方消滅）。
- 隊列の最外インベーダーが撃墜され、見かけ上の端が内側に移った際の端判定再計算。
- トーチカが完全に破壊された後の当たり判定スキップ。
- 同一フレームで最下段到達と最後の敵撃墜が同時に発生した場合: 最下段到達を優先し GAME OVER。

## 画面表示要素
- スコア、残機、ゲーム状態（PLAY/CLEAR/GAME OVER）。
- コントロールヒント（PC: ←→・Space）。

## 受け入れ条件（抜粋）
- 55体が所定の編成で出現し、端到達で下降・反転を繰り返す。
- プレイヤーは同時1発制限の弾を発射でき、着弾まで次弾は撃てない。
- トーチカは被弾・接触・自弾で段階的に破損する。
- スコアは段ごとの配点（30/20/10）で加算される。
- インベーダーの数が減ると移動が加速する。
- インベーダーが最下段に達すると即 GAME OVER 表示。
- 画面外にはオブジェクトが出ない。

## 実装指針（参考）
- 技術候補: HTML5 Canvas + TypeScript + Vite or Parcel。
- ループ: `requestAnimationFrame` によるゲームループ、固定タイムステップ近似。
- 入力: `keydown`/`keyup` で連続移動、発射はエッジ検出。
- 音: 発射音/爆発音/ゲームオーバー効果音（ミュート切替可）。

## 将来拡張（任意）
- ラウンド/ウェーブ進行、UFO的ボーナス敵、難易度選択、ハイスコア保存。

## Clarifications
- 本仕様は提供いただいた要件に基づく初版。追加要望や差分があれば `/clarify` 相当の質疑を行い、該当箇所を更新する。


